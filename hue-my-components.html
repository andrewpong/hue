<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Hue Components</title>
    <style>
        * {
            box-sizing: border-box;
            border: 0;
            padding: 0;
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }
        body {
            padding: 8pt;
        }
        h2 {
            margin-top: 4pt;
            margin-bottom: 4pt;
        }
        h3 {
            margin-top: 4pt;
            margin-bottom: 4pt;
        }
        div {
            margin-top: 4pt;
            margin-bottom: 4pt;
        }
        .component {
            border-radius: 8pt;
            padding: 8pt;
            margin: 8pt;
            background-color: whitesmoke;
        }
        .connected {
            color: silver;
        }
        .connected::before {
            content: "Connected: ";
        }
        .property {
            font-weight: bold;
        }
        h2 {
            color: silver;
        }
        select {
            -webkit-appearance: none;
            font-size: inherit;
            background: inherit;
        }
        option {
            -webkit-appearance: none;
            font-size: inherit;
            background: inherit;
        }
    </style>
    <script type="module">
        import { connect, getAllCategories, getComponents, setSensorValue } from "./hue-shared-resource.js";

        const hub = new URLSearchParams(document.location.search).get("hub") || "10.0.1.186";

        

        function valuesHTML(sensor) {
            return `<select data-sensor="${sensor.id}">\n` + 
                    sensor.values.map(s => `<option value="${s.value}" ${s.selected ? "selected" : ""}>${s.name}</option>`) +
                    `</select>\n`;
        }
        function propertyToHTML(sensor) {
            var v = sensor.values ? valuesHTML(sensor) : "";
            return `<div><span class="property">${sensor.metadata.property.replace(">", "â€º")}</span> = <span class="value" title="Last update: ${sensor.state.lastupdated}">${v}</span></div>`;
        }

        function componentToHTML(component) {

            var tiedToHTML = "";
            if (component.tiedTo){
                let category = component.tiedTo.category;
                let item = component.tiedTo.item;
                let description = (category === "sensors") ? item.productname : item.type;
                tiedToHTML =  (`<div class="connected">` + item.name + " (" + description + ")</div>\n");
            }
            var properties = component.sensors.filter(sensor => sensor.metadata).map(sensor => propertyToHTML(sensor)).join("\n");
            var html = `<div class="component"><h1>${component.name}</h1>
            <h2>${component.metadata.name} by ${component.metadata.manufacturer}</h2>
            ${tiedToHTML}
            ${properties}
            </div>`;
            return html;
        }

        async function main() {
            const connection = await connect(hub, "Callionica");
            const data = await getAllCategories(connection);
            const components = getComponents(data);
            const html = components.map(componentToHTML).join("\n");
            document.getElementById("data").innerHTML = html;

            function onSensorChange(evt) {
                const sensor = evt.srcElement.getAttribute("data-sensor");
                const value = evt.srcElement.value;
                setSensorValue(connection, sensor, value).then(x => console.log("Sensor change"));
                const timeout = 2.0 * 1000;
                window.setTimeout(() => {
                    document.location = document.location;
                     //main().then(x => console.log("Update"));
                }, timeout);
            }
            [...document.getElementsByTagName("select")].forEach(s => s.onchange = onSensorChange);
        }

        // const oneSecond = 1.0 * 1000;
        // window.setInterval(() => {
        //     main().then(x => console.log("Update"));
        // }, oneSecond);

        main().then(x => console.log("Initial"));
        
    </script>
</head>
<body>
    <h1>Hue Components</h1>
    <div id="data"></div>
</body>
</html>
