<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Hue Connect</title>
    <style>
            * {
                box-sizing: border-box;
                border: 0;
                padding: 0;
                margin: 0;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            }
            input {
                font-size: inherit;
            }
            a {
                color: inherit;
                background-color: silver;
                padding-left: 2pt;
                padding-right: 2pt;
                padding: 2pt;
                border-radius: 4pt;
                text-decoration: none;
            }
            ol {
                padding-left: 24pt;
            }
            body {
                padding: 8pt;
            }
            h2 {
                margin-top: 4pt;
                margin-bottom: 4pt;
            }
            h3 {
                margin-top: 4pt;
                margin-bottom: 4pt;
            }
            p {
                margin-top: 8pt;
                margin-bottom: 8pt;
            }
            div {
                margin-top: 4pt;
                margin-bottom: 4pt;
            }
            #pmz {
                border-radius: 8pt;
                padding: 8pt;
                margin: 8pt;
                background-color: whitesmoke;
            }
            #dimmer {
                border-radius: 8pt;
                padding: 8pt;
                margin: 8pt;
                background-color: whitesmoke;
            }
            .bridgeip {
                font-weight: bold;
            }
            .unavailableip {
                font-weight: bold;
            }
            .connected {
                color: silver;
            }
            .connected::before {
                content: "Connected: ";
            }
            .property {
                font-weight: bold;
            }
            h2 {
                color: silver;
            }
            td {
                padding-left: 12pt;
            }
            select {
                -webkit-appearance: none;
                font-size: inherit;
                background: inherit;
            }
            option {
                -webkit-appearance: none;
                font-size: inherit;
                background: inherit;
            }
            button {
                font-size: inherit;
                padding: 4pt;
                border-radius: 4pt;
                background-color: silver;
            }
        </style>
    <script type="module">
        import { connect, bridgeByIP, bridgeIPsByDiscovery, bridgesByDiscovery, loadConnection, storeConnection, testConnection, register } from "./hue-callionica-connect.js";

        class UIBridge {
            constructor(root, ip) {
                this.root = root;
                this.ip = ip;

                this.name_ = "Bridge";
                this.status_ = "";

                this.root.innerHTML = `<span class="bridgename">Bridge</span>: <span class="bridgeip">${ip}</span> <span class="bridgestatus"></span>`;

                this.rootName = this.root.querySelector(".bridgename");
                this.rootIP = this.root.querySelector(".bridgeip");
                this.rootStatus = this.root.querySelector(".bridgestatus");
            }

            get name() {
                return this.name_;
            }

            set name(value) {
                this.name_ = value;
                this.rootName.innerText = value;
            }

            get status() {
                return this.status_;
            }
            
            set status(value) {
                this.status_ = value;
                this.rootStatus.innerText = value;
            }
        }

        class UIBridges {
            constructor(root) {
                this.root = root;
                this.bridges = [];
            }

            getBridge(ip) {
                return this.bridges.find(bridge => bridge.ip === ip);
            }

            addBridge(ip) {
                const existing = this.getBridge(ip);
                if (existing) {
                    return existing;
                }

                const bridgeRoot = this.root.ownerDocument.createElement("div");
                bridgeRoot.id = ip;
                this.root.appendChild(bridgeRoot);

                const current = new UIBridge(bridgeRoot, ip);
                this.bridges.push(current);

                return current;
            }
        }

        class BridgeConnector {
            constructor() {
                this.didManualIP = false;
                this.ui = {
                    bridges: new UIBridges(document.getElementById("bridges")),
                    status: document.getElementById("status"),
                    help: document.getElementById("help"),
                };
                this.tokens = {};
                this.ips = [];
                this.unavailable = [];
                this.bridges = [];
                this.unconnected = [];
                this.connections = [];
            }

            addConnection(connection) {
                this.connections.push(connection);
                storeConnection(connection);

                const ui = this.ui.bridges.getBridge(connection.bridge.ip);
                ui.status = "Connected: " + connection.token;
            }

            addUnconnected(bridge) {
                if (!this.didManualIP) {
                    this.didManualIP = true;
                    document.getElementById("manual-ip").value = bridge.ip;
                }

                if (this.unconnected.find(b => b.id === bridge.id)) {
                    return;
                }

                this.unconnected.push(bridge);

                const ui = this.ui.bridges.getBridge(bridge.ip).rootStatus;
                ui.innerHTML = `<button class="connect">Connect</button>`;
            }

            addIP(ip, token) {
                if (token) {
                    this.tokens[ip] = token;
                }

                if (this.ips.find(i => i === ip)) {
                    return;
                }

                this.ui.bridges.addBridge(ip);

                const empty = this.ips.length === 0;
                this.ips.push(ip);
                if (empty) {
                    this.processIPs().then(x => console.log("IPs"));;
                }
            }

            addUnavailable(ip) {
                if (!this.didManualIP) {
                    this.didManualIP = true;
                    document.getElementById("manual-ip").value = ip;
                }
                this.unavailable.push(ip);

                const ui = this.ui.bridges.getBridge(ip).rootStatus;
                ui.innerHTML = `<a href="https://${ip}/api/unauthenticated/config">Check certificate</a>`;

                this.ui.help.innerHTML = `
                <h2>Check certificates</h2>
                <p>Not all of the reported bridges were available.</p>
                <p>A bridge may be unavailable if your browser does not trust the self-signed certificate of that bridge.</p>
                <p>You can check the certificate and fix the problem by clicking <a href="https://${ip}/api/unauthenticated/config">Check certificate</a> for each bridge.</p>
                <p>If you see an error page in the browser that says "Your connection is not private" or "This connection is not private", it means that your browser does not trust the Hue bridge's self-signed certificate.</p>
                <p>When the browser does trust the Hue bridge's self-signed certificate, you'll see some data displayed instead of an error page.</p>

                <b>To trust the certificate and fix the problem:</b>
                <ol>
                <li><p>Click <a href="https://${ip}/api/unauthenticated/config">Check certificate</a></p></li>
                <li>
                    <p>When the error page appears:</p>
                    <p>In Chrome, click "<b>Advanced</b>", then "<b>Proceed to ${ip} (unsafe)</b>"</p>
                    <p>In Safari, click "<b>visit this website</b>"</p>
                    <p>Other browsers will allow you to trust the Hue bridge's self-signed certificate in a similar way.</p>
                </li>
                <li><p>Use your browser's back button to return to this page.</p></li>
                </ol>
                
                <p>You will need to do this once only for each bridge that you want to use in this browser.</p>
                <p>If you switch browsers, you will need to trust the self-signed certificate again in the new browser.</p>
                `;
            }

            addBridge(bridge) {
                const ui = this.ui.bridges.addBridge(bridge.ip);
                ui.id = bridge.id;
                ui.name = bridge.name;

                const empty = this.bridges.length === 0;
                this.bridges.push(bridge);
                if (empty) {
                    this.processBridges().then(x => console.log("Bridges"));
                }
            }

            async processIP(ip) {
                // this.ui.status.innerText = `Contacting bridge ${ip}...`;
                try {
                    const bridge = await bridgeByIP(ip);
                    this.addBridge(bridge);
                } catch (e) {
                    this.addUnavailable(ip);
                }
            }

            async processIPs() {
                // this.ui.status.innerText = "Contacting bridges...";
                let ip;
                while (ip = this.ips.pop()) {
                    this.processIP(ip).then(x => console.log("IP"));;
                }
            }

            async processBridge(bridge) {
                // this.ui.status.innerText = `Connecting to bridge ${bridge.name}...`;
                const app = "Callionica";

                async function test(connector, connection) {
                    let working = await testConnection(connection);
                    if (working) {
                        connector.addConnection(connection);
                        return connection;
                    }
                }

                let connection = loadConnection(app, bridge);
                if (connection) {
                    // Bridge may have changed name or IP since last stored
                    let currentConnection = { bridge, app, token: connection.token };
                    if (await test(this, currentConnection)) {
                        return;
                    }
                }

                const token = this.tokens[bridge.ip];
                if (token) {
                    let currentConnection = { bridge, app, token };
                    if (await test(this, currentConnection)) {
                        return;
                    }
                }

                this.addUnconnected(bridge);
            }

            async processBridges() {
                // this.ui.status.innerText = "Connecting to bridges...";
                let bridge;
                while (bridge = this.bridges.pop()) {
                    this.processBridge(bridge).then(x => console.log("Bridge"));;
                }
            }
        }

        const connector = new BridgeConnector();

        function htmlBridgeIP(ip, n) {
            return `<div id="${ip}">Bridge ${n+1}: ${ip}</div>`;
        }

        function htmlBridge(bridge) {
            return `<span class="bridgename">${bridge.name}</span>: <span class="bridgeip">${bridge.ip}</span> <span class="status">OK</span>`;
        }

        function populateManual(ip) {
            const input = document.getElementById("manual-ip");
            input.value = ip;
        }

        // function doBridgeIP(ip, token, status) {
        //     const bridge = await bridgeByIP(ip);
        // }

        function onclick(evt) {
            const id = evt.srcElement.id;

            if (id === "manual-button") {
                const ipInput = document.getElementById("manual-ip");
                const ip = ipInput.value;

                const tokenInput = document.getElementById("manual-token");
                const token = tokenInput.value || undefined;

                connector.addIP(ip, token);
                return;
            }

            // const op = evt.srcElement.getAttribute("data-op");
            // if (op) {
            //     if (op === "connect") {

            //     }
            // }
        }

        async function main() {
            document.onclick = onclick;

            const bridgeIPs = await bridgeIPsByDiscovery();

            connector.ui.status.innerText = "";

            bridgeIPs.forEach(ip => connector.addIP(ip));
            return;

            if (bridgeIPs[0]) {
                populateManual(bridgeIPs[0])
            }

            const d = document.getElementById("discovered");
            const dh = bridgeIPs.map(htmlBridgeIP).join("\n");
            d.innerHTML = dh;

            const help = document.getElementById("help");
            help.innerHTML = "Contacting the Hue bridges...";

            const bridges = [];
            const unavailableIPs = [];
            for (const bridgeIP of bridgeIPs) {
                //ui.bridges.addBridge(bridgeIP);
                const el = document.getElementById(bridgeIP);
                try {
                    const bridge = await bridgeByIP(bridgeIP);
                    bridges.push(bridge);
                    el.innerHTML = htmlBridge(bridge);
                } catch (e) {
                    unavailableIPs.push(bridgeIP);
                    el.innerHTML = `Unavailable: <span class="unavailableip">${bridgeIP}</span> <a href="https://${bridgeIP}/api/unauthenticated/config">Check certificate</a>`;
                }
            }

            if (unavailableIPs[0]) {
                populateManual(unavailableIPs[0])
            }

            if (bridges.length < bridgeIPs.length) {
                help.innerHTML = `
                <h2>Check certificates</h2>
                <p>Not all of the reported bridges were available.</p>
                <p>A bridge may be unavailable if your browser does not trust the self-signed certificate of that bridge.</p>
                <p>You can check the certificate and fix the problem by clicking <a href="https://${unavailableIPs[0]}/api/unauthenticated/config">Check certificate</a> for each bridge.</p>
                <p>If you see an error page in the browser that says "Your connection is not private" or "This connection is not private", it means that your browser does not trust the Hue bridge's self-signed certificate.</p>
                <p>When the browser does trust the Hue bridge's self-signed certificate, you'll see some data displayed instead of an error page.</p>
                <b>To trust the certificate and fix the problem:</b>
                <ol>
                <li><p>Click <a href="https://${unavailableIPs[0]}/api/unauthenticated/config">Check certificate</a></p></li>
                <li>
                    <p>When the error page appears:</p>
                    <p>In Chrome, click "<b>Advanced</b>", then "<b>Proceed to ${unavailableIPs[0]} (unsafe)</b>"</p>
                    <p>In Safari, click "<b>visit this website</b>"</p>
                    <p>Other browsers will allow you to trust the Hue bridge's self-signed certificate in a similar way.</p>
                </li>
                <li><p>Use your browser's back button to return to this page.</p></li>
                </ol>
                
                
                <p>You will need to do this once only for each bridge that you want to use in this browser.</p>
                <p>If you switch browsers, you will need to trust the self-signed certificate again in the new browser.</p>
                
                `;
            } else {
                help.innerHTML = "";
            }

            function updateStatus(bridge, html) {
                const el = document.getElementById(bridge.ip);
                const status = el.querySelector(".status");
                status.innerHTML = html;
            }

            const app = "Callionica";
            for (const bridge of bridges) {
                let connection = loadConnection(app, bridge);
                if (connection) {
                    console.log(connection);
                    // Bridge may have changed name or IP since last stored
                    let currentConnection = { bridge, app, token: connection.token };
                    let working = await testConnection(currentConnection);
                    if (working) {
                        console.log(currentConnection);
                        updateStatus(bridge, "Connected: " + currentConnection.token);
                        storeConnection(currentConnection);
                    } else {
                        
                    }
                } else {
                    updateStatus(bridge, `<a href="hue-callionica-connect-2.html?ip=${bridge.ip}&name=${bridge.name}">Connect</a>`);
                    // const currentConnection = register(bridge, app);
                    // if (currentConnection) {
                    //     let working = await testConnection(currentConnection);
                    //     if (working) {
                    //         console.log(currentConnection);
                    //         storeConnection(currentConnection);
                    //     } else {

                    //     }
                    // }
                }
            }
            // const bridges = await bridgesByDiscovery();
            // console.log(bridges);

            // const bridge = await bridgeByIP(hub);
            // console.log(bridge);
        }

        main().then(x => console.log("Done"));
    </script>
</head>
<body>
    <h1>Connect to a Philips Hue Bridge</h1>
    <div id="bridges"></div>
    <div id="status">Getting bridges...</div>
    <div id="manual">
        <h2>Advanced</h2>
        <p>If you know your bridge's IP address, you can enter it here:</p>
        <p>IP Address: <input id="manual-ip" type="text" maxlength="40" placeholder="192.168.0.2" value="192.168.0.2"></p>
        <p>Token: <input id="manual-token" type="text" maxlength="128" placeholder="(Optional)" value=""></p>
        <p></p><button id="manual-button" href="hue-callionica-connect-2.html?ip=192.168.0.2">Search</button></p>
    </div>
    <div id="help"></div>
</body>
</html>
