<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Hue Sensor Rules</title>
    <link rel="stylesheet" href="hue-callionica.css">
    <script type="module">
        import { loadCurrentBridge, loadConnection } from "./hue-callionica-connect.js";
        import { sortBy, getAll, getCapabilities, getSensorTriggeredRules } from "./hue-callionica.js";

        function sensorCategory(sensor) {
            if (sensor.metadata) {
                return "components";
            }
            
            if (sensor.type === "ZLLSwitch") {
                return "switches";
            }

            return "other";
        }
        
        function sensorKind(sensor) {
            if (sensor.metadata) {
                return `${sensor.metadata.component} > ${sensor.metadata.property}`.replaceAll(">", "›");
            }
            return sensor.productname || sensor.modelid;
        }

        function sensorStats(data) {
            const rules = Object.values(data.rules);
            
            const result = {
                switches: [],
                components: [],
                other: [],
            };

            for (const sensor of Object.values(data.sensors)) {
                const category = sensorCategory(sensor);
                const o = {
                    ...sensor,
                    kind: sensorKind(sensor),
                    rules: getSensorTriggeredRules(rules, sensor.id)
                };
                result[category].push(o);
            }
    
            result.components = result.components.sort(sortBy(s => s.component.name + s.kind + s.component.id));
            result.switches = result.switches.sort(sortBy(s => s.name));
            result.other = result.other.sort(sortBy(s => s.name));
            return result;
        }

        function sensorHTML(sensor) {
            return `
            <tr title="ID: ${sensor.id}"><td>${sensor.name}</td><td>${sensor.kind}</td><td>${sensor.manufacturername}</td><td style="text-align: right;">${sensor.rules.length}</td><td><a href="hue-callionica-data.html#sensors-${sensor.id}">➲</a></tr>
            `;
        }

        function componentSensorHTML(data, sensor) {
            const name = sensor.component?.name || sensor.name;
            return `
            <tr title="ID: ${sensor.id}"><td>${name}</td><td>${sensor.kind}</td><td style="text-align: right;">${sensor.rules.length}</td><td><a href="hue-callionica-components.html#components-${sensor.component.id}">➲</a></td></tr>
            `;
        }

        function sensorStatsHTML(data, stats) {
            return `
            <h1>Rules triggered by each sensor</h1>
            <h3>Component Sensors</h3>
            <table>
            ${stats.components.map(sensor => componentSensorHTML(data, sensor)).join("\n")}
            </table>
            <h3>Switches & Other Sensors</h3>
            <table>
            ${stats.switches.map(sensorHTML).join("\n")}
            ${stats.other.map(sensorHTML).join("\n")}
            </table>
            `;
        }

        async function main() {
            const bridge = loadCurrentBridge();
            const connection = await loadConnection("Callionica", bridge);
            const data = await getAll(connection);
            const capabilities = await getCapabilities(connection);

            const o = {};
            ["sensors", "components", "rules", "schedules", "groups", "lights", "scenes"].forEach(n => o[n] = Object.values(data[n]));

            const counts = [
                ["Components", () => o.components.length],
                ["Sensors", () => o.sensors.length, capabilities.sensors.total],
                // ["CLIP Sensors", () => (capabilities.sensors.clip.total - capabilities.sensors.clip.available), capabilities.sensors.clip.total],
                ["Rules", () => o.rules.length, capabilities.rules.total],
                ["Conditions", () => o.rules.reduce((p, c) => p + c.conditions.length, 0), capabilities.rules.conditions.total],
                ["Actions", () => o.rules.reduce((p, c) => p + c.actions.length, 0), capabilities.rules.actions.total],
                ["Schedules", () => o.schedules.length, capabilities.schedules.total],
                ["Groups", () => o.groups.length, capabilities.groups.total],
                ["Lights", () => o.lights.length, capabilities.lights.total],
                ["Scenes", () => o.scenes.length, capabilities.scenes.total],
                ["Passwords", () => Object.values(data.config.whitelist).length],
            ];

            const html = `<h1>${connection.bridge.name}</h1>
            <h2>Statistics</h2>` 
            + counts.map(count => `<p>${count[0]}: ${count[1]()}${count[2] ? " of " + count[2] : ""}</p>`).join("\n") + "<p> </p>" +  sensorStatsHTML(data, sensorStats(data));
            document.getElementById("statistics").innerHTML = html;
        }

        main().then(x => console.log("Done"));
    </script>
</head>
<body>
    <h1>Hue Sensor Rules</h1>
    <p>Here you can the rules triggered by each sensor.</p>
    <hr/>
    <div id="statistics"></div>
</body>
</html>
